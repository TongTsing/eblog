$(document).ready(function () {
    // 提交评论表单
    $("form.comment-form").submit(function (event) {
        event.preventDefault();  // 阻止表单默认提交行为

        var form = $(this);
        var formData = form.serialize();  // 获取表单数据

        $.ajax({
            url: form.attr("action"),
            type: "POST",  // 明确指定为 POST 请求
            data: formData,
            success: function(response) {
                if (response.error) {
                    alert(response.error);
                } else {
                    // 更新评论列表
                    $("#comments-container").prepend(
                        `<div class="row mb-3">
                            <div class="col-auto">
                                <img src="/path/to/avatar.jpg" alt="用户头像" class="rounded-circle" width="40" height="40">
                            </div>
                            <div class="col">
                                <h5>${response.comment.author}</h5>
                                <p>${response.comment.content}</p>
                                <small class="text-muted">${response.comment.pub_time}</small>
                            </div>
                        </div>`
                    );
                }
            },
            error: function() {
                alert("评论发布失败，请稍后再试。");
            }
        });
    });

    // 使用事件委托为动态生成的回复按钮添加点击事件
    $(document).on('click', '.reply-btn', function () {
        var commentId = $(this).data('comment-id');
        var formId = '#reply-form-' + commentId;
        $(formId).toggle();  // 显示或隐藏回复表单
    });

    // 提交回复表单
    $("form.reply-form").submit(function (event) {
        event.preventDefault();  // 阻止表单默认提交行为

        var form = $(this);
        var formData = form.serialize();  // 获取回复表单数据

        $.ajax({
            url: form.attr("action"),
            type: "POST",  // 明确指定为 POST 请求
            data: formData,
            success: function(response) {
                if (response.error) {
                    alert(response.error);
                } else {
                    // 更新评论列表中的回复
                    var commentId = form.find('input[name="parent_id"]').val();
                    var replyContainer = $('#comment-' + commentId + '-replies');
                    replyContainer.append(
                        `<div class="row mt-3 ms-4">
                            <div class="col-auto">
                                <img src="${response.comment.new_comment_user_pic}" alt="用户头像" class="rounded-circle" width="40" height="40">
                            </div>
                            <div class="col">
                                <h5>${response.comment.author}</h5>
                                <p>${response.comment.content}</p>
                                <small class="text-muted">${response.comment.pub_time}</small>
                            </div>
                        </div>`
                    );
                    form[0].reset();  // 清空回复输入框
                }
            },
            error: function() {
                alert("回复发布失败，请稍后再试。");
            }
        });
    });
});
